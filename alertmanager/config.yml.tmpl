global:
  resolve_timeout: 5m

route:
  receiver: 'slack-alerts'
  group_by: ['alertname', 'cluster', 'service', 'instance']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # Kafka-specific routing
    - match:
        service: kafka
      receiver: 'slack-kafka'
      group_by: ['alertname', 'topic', 'consumer_group']
      continue: false
    
    - match:
        service: kafka-producer
      receiver: 'slack-kafka'
      continue: false
    
    - match:
        service: kafka-consumer
      receiver: 'slack-kafka'
      continue: false

    - match:
        severity: critical
      receiver: 'slack-critical'
      group_by: ['alertname', 'instance']
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 30m

    - match:
        severity: warning
      receiver: 'slack-warning'
      group_by: ['alertname', 'service']
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 12h

    - match:
        severity: info
      receiver: 'slack-info'
      group_by: ['alertname']
      group_wait: 5m
      group_interval: 30m
      repeat_interval: 24h

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  - source_match_re:
      severity: '(critical|warning)'
    target_match:
      severity: 'info'
    equal: ['alertname', 'instance']

  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighResponseTime|HighErrorRate|HighMemoryUsage|HighCPU)'
    equal: ['service', 'instance']

  - source_match_re:
      alertname: '(MongoDBConnectionDown|RedisConnectionDown)'
    target_match_re:
      alertname: '(HighQuery.*|SlowQuery.*)'
    equal: ['service']

  - source_match:
      alertname: 'KafkaConnectionDown'
    target_match:
      alertname: 'HighKafkaConsumerLag'
    equal: ['instance']

receivers:

  # Add Kafka-specific receiver
  - name: 'slack-kafka'
    slack_configs:
      - api_url: '${SLACK_KAFKA_WEBHOOK}'
        channel: '${SLACK_KAFKA_CHANNEL}'
        send_resolved: true
        username: 'Kafka Alerts'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: |-
          {{ if eq .Status "firing" }}:warning: [KAFKA ALERT]{{ else }}:white_check_mark: [RESOLVED]{{ end }}
          {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          {{ if .Labels.topic }}*Topic:* {{ .Labels.topic }}{{ end }}
          {{ if .Labels.consumer_group }}*Consumer Group:* {{ .Labels.consumer_group }}{{ end }}
          *Instance:* {{ .Labels.instance }}
          {{ if .GeneratorURL }}<{{ .GeneratorURL }}|View Graph>{{ end }}
          {{ end }}
          
  - name: 'slack-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK}'
        channel: '${SLACK_CHANNEL}'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Alertmanager'
        title: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
        text: |-
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ if .GeneratorURL }}*Graph:* <{{ .GeneratorURL }}|View in Prometheus>{{ end }}
          {{ end }}

  - name: 'slack-critical'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK}'
        channel: '${SLACK_CHANNEL}'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Alertmanager'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: |-
          {{ if eq .Status "firing" }}:rotating_light: *[CRITICAL ALERT]* :rotating_light:{{ else }}:white_check_mark: *[RESOLVED]* :white_check_mark:{{ end }}
          {{ .CommonLabels.alertname }}
          {{ if .CommonLabels.service }}(Service: *{{ .CommonLabels.service }}*){{ end }}
        text: |-
          *Status:* `{{ .Status | toUpper }}`
          {{ if gt (len .Alerts.Firing) 0 }}*Firing:* {{ .Alerts.Firing | len }} alert(s){{ end }}
          {{ if gt (len .Alerts.Resolved) 0 }}*Resolved:* {{ .Alerts.Resolved | len }} alert(s){{ end }}

          {{ range .Alerts }}
          {{ if eq .Status "firing" }}:fire:{{ else }}:white_check_mark:{{ end }} *{{ .Labels.alertname }}*
          {{ if .Annotations.summary }}> {{ .Annotations.summary }}{{ end }}
          {{ if .Annotations.description }}*Description:* {{ .Annotations.description }}{{ end }}
          {{ if .Annotations.runbook_url }}:notebook: *Runbook:* <{{ .Annotations.runbook_url }}|View Runbook>{{ end }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ if ne .EndsAt.Unix 0 }}*Ended:* {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}
          
          *Labels:*
          {{ range .Labels.SortedPairs }}  • *{{ .Name }}:* `{{ .Value }}`
          {{ end }}
          {{ if .GeneratorURL }}:chart_with_upwards_trend: <{{ .GeneratorURL }}|View in Prometheus>{{ end }}
          ---
          {{ end }}

  - name: 'slack-warning'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK}'
        channel: '${SLACK_CHANNEL}'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Alertmanager'
        color: 'warning'
        title: |-
          {{ if eq .Status "firing" }}:warning: *[WARNING]* :warning:{{ else }}:white_check_mark: [RESOLVED]{{ end }}
          {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          {{ if .Annotations.summary }}*Summary:* {{ .Annotations.summary }}{{ end }}
          {{ if .Annotations.description }}*Description:* {{ .Annotations.description }}{{ end }}
          *Service:* {{ .Labels.service }} | *Instance:* {{ .Labels.instance }}
          *Started:* {{ .StartsAt.Format "15:04:05 MST" }}
          {{ if .GeneratorURL }}<{{ .GeneratorURL }}|View Graph>{{ end }}
          {{ end }}

  - name: 'slack-info'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK}'
        channel: '${SLACK_CHANNEL}'
        send_resolved: false
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        username: 'Alertmanager'
        color: '#36a64f'
        title: ':information_source: [INFO] {{ .GroupLabels.alertname }}'
        text: |-
          *{{ .Alerts | len }} alert(s)* in this group
          {{ range .Alerts }}
          • {{ .Annotations.description }}
          {{ end }}
